<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canadian Tire Service Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        /* Professional Header */
        .header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: white;
            padding: 25px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-bottom: 3px solid #E31837;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            text-align: center;
        }

        .logo {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            text-align: center;
            border-left: 4px solid #E31837;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #E31837;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Dashboard Tabs */
        .dashboard-tabs {
            display: flex;
            background: white;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 16px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.95rem;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            background: white;
            color: #E31837;
            border-bottom: 3px solid #E31837;
        }

        .tab:hover:not(.active) {
            background: #e9ecef;
            color: #333;
        }

        /* Tab Content */
        .tab-content {
            background: white;
            border-radius: 0 0 8px 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            min-height: 500px;
            border: 1px solid #e9ecef;
            border-top: none;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Call Sessions - Simplified */
        .session-item {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 3px solid #E31837;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 20px;
            align-items: center;
        }

        .session-date {
            font-weight: 600;
            color: #333;
        }

        .session-time {
            color: #666;
            font-size: 0.9rem;
        }

        .session-duration {
            background: #E31837;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
        }

        .session-status {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active { background: #d4edda; color: #155724; }
        .status-ended { background: #f8d7da; color: #721c24; }

        /* Customer Data */
        .customer-card {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 3px solid #0066CC;
        }

        .customer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .customer-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }

        .customer-phone {
            color: #666;
            font-size: 0.9rem;
        }

        .customer-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .detail-item {
            background: white;
            padding: 12px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .detail-label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .detail-value {
            font-weight: 600;
            color: #333;
        }

        /* Appointments - Calendar Style */
        .calendar-view {
            display: grid;
            gap: 20px;
        }

        .calendar-day {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            border: 1px solid #e9ecef;
        }

        .day-header {
            background: linear-gradient(135deg, #E31837 0%, #C41230 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .day-date {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .day-number {
            font-size: 2.2rem;
            font-weight: 700;
            line-height: 1;
        }

        .day-info {
            display: flex;
            flex-direction: column;
        }

        .day-name {
            font-size: 1.1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .month-name {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .day-stats {
            text-align: right;
        }

        .appointment-count {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .day-utilization {
            font-size: 0.8rem;
            opacity: 0.8;
            background: rgba(255,255,255,0.2);
            padding: 4px 8px;
            border-radius: 10px;
        }

        .day-appointments {
            padding: 20px;
        }

        .appointment-item {
            display: grid;
            grid-template-columns: 120px 1fr 200px;
            gap: 20px;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            margin-bottom: 10px;
            background: #f8f9fa;
            transition: all 0.2s ease;
        }

        .appointment-item:hover {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .appointment-time {
            text-align: center;
            padding: 12px;
            background: linear-gradient(135deg, #28A745 0%, #20C997 100%);
            color: white;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .time-display {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 3px;
        }

        .time-slot {
            font-size: 0.7rem;
            opacity: 0.9;
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .appointment-details {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .customer-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }

        .service-type {
            font-size: 0.9rem;
            color: #E31837;
            font-weight: 500;
            background: rgba(227,24,55,0.1);
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
            width: fit-content;
        }

        .vehicle-info {
            font-size: 0.85rem;
            color: #666;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .appointment-meta {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 0.8rem;
            color: #888;
            text-align: right;
        }

        .call-id {
            background: #e9ecef;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: monospace;
        }

        /* Analytics */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .analytics-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }

        .analytics-card h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .metric-item {
            text-align: center;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #E31837;
            margin-bottom: 5px;
        }

        .metric-label {
            color: #666;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .service-metric, .location-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .service-name, .location-name {
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }

        .service-count, .location-count {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Loading and Error States */
        .loading, .no-data, .error-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .loading {
            font-size: 1.1rem;
        }

        .error-state {
            color: #721c24;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 6px;
            padding: 20px;
        }

        .error-state h3 {
            color: #721c24;
            margin-bottom: 15px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                padding: 0 15px;
            }
            
            .logo {
                font-size: 1.8rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-tabs {
                flex-direction: column;
            }
            
            .tab {
                border-radius: 0;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .session-item {
                grid-template-columns: 1fr;
                gap: 10px;
                text-align: center;
            }
            
            .appointment-item {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .appointment-time {
                order: -1;
            }
        }
    </style>
</head>
<body>
    <!-- Professional Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo">CANADIAN TIRE</div>
            <div class="subtitle">Service Department Dashboard</div>
        </div>
    </div>

    <div class="container">
        <!-- Statistics Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="total-calls">-</div>
                <div class="stat-label">Total Calls</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="active-calls">-</div>
                <div class="stat-label">Active Calls</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="appointments-booked">-</div>
                <div class="stat-label">Appointments</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="data-completion">-</div>
                <div class="stat-label">Data Completion</div>
            </div>
        </div>

        <!-- Dashboard Navigation -->
        <div class="dashboard-tabs">
            <button class="tab active" onclick="showTab('sessions')">üìû Call Sessions</button>
            <button class="tab" onclick="showTab('customers')">üë• Customer Data</button>
            <button class="tab" onclick="showTab('appointments')">üìÖ Appointments</button>
            <button class="tab" onclick="showTab('analytics')">üìä Analytics</button>
        </div>

        <!-- Dashboard Content -->
        <div class="tab-content">
            <!-- Call Sessions Tab -->
            <div id="sessions" class="tab-pane active">
                <div id="sessions-content">
                    <div class="loading">Loading call sessions...</div>
                </div>
            </div>

            <!-- Customer Data Tab -->
            <div id="customers" class="tab-pane">
                <div id="customers-content">
                    <div class="loading">Loading customer data...</div>
                </div>
            </div>

            <!-- Appointments Tab -->
            <div id="appointments" class="tab-pane">
                <div id="appointments-content">
                    <div class="loading">Loading appointments...</div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics" class="tab-pane">
                <div id="analytics-content">
                    <div class="loading">Loading analytics...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let currentData = null;

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            loadTabContent(tabName);
        }

        // Load content for specific tabs
        function loadTabContent(tabName) {
            switch(tabName) {
                case 'sessions':
                    displaySessions();
                    break;
                case 'customers':
                    displayCustomers();
                    break;
                case 'appointments':
                    displayAppointments();
                    break;
                case 'analytics':
                    displayAnalytics();
                    break;
            }
        }

        // Load data on page load
        function loadInitialData() {
            console.log('üöÄ Loading dashboard data...');
            
            const storedData = loadDataFromStorage();
            if (storedData && storedData.length > 0) {
                currentData = storedData;
                updateStats();
                displaySessions();
                displayCustomers();
                displayAppointments();
                displayAnalytics();
                console.log('üìÇ Loaded data from storage:', storedData.length, 'sessions');
            }
            
            fetchDataFromAPI();
        }

        // Fetch data from API
        async function fetchDataFromAPI() {
            try {
                console.log('üîÑ Fetching fresh data from API...');
                
                const response = await fetch(`${API_BASE}/api/call/sessions`);
                console.log('üì° Response received:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üìä Data parsed:', data);
                
                if (data.success && data.sessions && data.sessions.length > 0) {
                    currentData = data.sessions;
                    console.log('‚úÖ Fetched data from API:', data.sessions.length, 'sessions');
                    
                    saveDataToStorage(currentData);
                    updateStats();
                    displaySessions();
                    displayCustomers();
                    displayAppointments();
                    displayAnalytics();
                } else {
                    console.log('üì≠ No sessions returned from API');
                }
            } catch (error) {
                console.error('‚ùå Error fetching data from API:', error);
                
                if (!currentData || currentData.length === 0) {
                    showErrorState(error.message);
                }
            }
        }

        // Update statistics
        function updateStats() {
            if (!currentData) return;
            
            const totalCalls = currentData.length;
            const activeCalls = currentData.filter(s => s.status === 'active').length;
            const appointmentsBooked = currentData.filter(s => s.appointmentBooked).length;
            
            let totalFields = 0;
            let completedFields = 0;
            
            currentData.forEach(session => {
                const customerInfo = session.customerInfo;
                Object.values(customerInfo).forEach(value => {
                    totalFields++;
                    if (value !== null && value !== undefined && value !== '') {
                        completedFields++;
                    }
                });
            });
            
            const dataCompletion = totalFields > 0 ? Math.round((completedFields / totalFields) * 100) : 0;
            
            document.getElementById('total-calls').textContent = totalCalls;
            document.getElementById('active-calls').textContent = activeCalls;
            document.getElementById('appointments-booked').textContent = appointmentsBooked;
            document.getElementById('data-completion').textContent = dataCompletion + '%';
        }

        // Display call sessions - Simplified
        function displaySessions() {
            if (!currentData || currentData.length === 0) {
                document.getElementById('sessions-content').innerHTML = 
                    '<div class="no-data">No call sessions found.</div>';
                return;
            }

            // Check for corrupted data
            const corruptedSessions = currentData.filter(session => {
                const customerInfo = session.customerInfo;
                return !customerInfo || Object.values(customerInfo).every(value => value === null || value === undefined);
            });

            if (corruptedSessions.length > 0) {
                document.getElementById('sessions-content').innerHTML = `
                    <div class="error-state">
                        <h3>‚ö†Ô∏è Data Corruption Detected</h3>
                        <p>We found ${corruptedSessions.length} corrupted sessions. This happened during a cleanup process.</p>
                        <p><strong>Solution:</strong> The system needs to be reset and data recreated.</p>
                    </div>
                `;
                return;
            }

            const sessionsHtml = currentData.map(session => {
                const startTime = new Date(session.startTime);
                const endTime = session.endTime ? new Date(session.endTime) : new Date();
                const durationMs = endTime - startTime;
                const durationMinutes = Math.floor(durationMs / (1000 * 60));
                const durationText = durationMinutes > 0 ? `${durationMinutes}m` : '<1m';
                
                const statusClass = `status-${session.status}`;
                
                return `
                    <div class="session-item">
                        <div class="session-date">
                            <div>${startTime.toLocaleDateString()}</div>
                            <div class="session-time">${startTime.toLocaleTimeString()}</div>
                        </div>
                        <div class="session-duration">${durationText}</div>
                        <div class="session-status ${statusClass}">${session.status.toUpperCase()}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('sessions-content').innerHTML = sessionsHtml;
        }

        // Display customer data
        function displayCustomers() {
            if (!currentData || currentData.length === 0) {
                document.getElementById('customers-content').innerHTML = 
                    '<div class="no-data">No customer data available.</div>';
                return;
            }

            // Check for corrupted data
            const corruptedSessions = currentData.filter(session => {
                const customerInfo = session.customerInfo;
                return !customerInfo || Object.values(customerInfo).every(value => value === null || value === undefined);
            });

            if (corruptedSessions.length > 0) {
                document.getElementById('customers-content').innerHTML = `
                    <div class="error-state">
                        <h3>‚ö†Ô∏è Data Corruption Detected</h3>
                        <p>Customer data is corrupted due to a cleanup process issue.</p>
                    </div>
                `;
                return;
            }

            const completeSessions = currentData.filter(session => {
                const customerInfo = session.customerInfo;
                return customerInfo.name && customerInfo.phone && customerInfo.serviceType;
            });

            if (completeSessions.length === 0) {
                document.getElementById('customers-content').innerHTML = `
                    <div class="error-state">
                        <h3>‚ö†Ô∏è No Valid Customer Data</h3>
                        <p>All customer data appears to be corrupted or incomplete.</p>
                    </div>
                `;
                return;
            }

            const customers = {};
            completeSessions.forEach(session => {
                const phone = session.customerInfo.phone;
                if (phone && !customers[phone]) {
                    customers[phone] = {
                        phone,
                        name: session.customerInfo.name,
                        email: session.customerInfo.email,
                        carMake: session.customerInfo.carMake,
                        carModel: session.customerInfo.carModel,
                        carYear: session.customerInfo.carYear,
                        triangleMember: session.customerInfo.triangleMember,
                        location: session.customerInfo.location,
                        calls: 0,
                        appointmentsBooked: 0
                    };
                }
                if (phone && customers[phone]) {
                    customers[phone].calls++;
                    if (session.appointmentBooked) {
                        customers[phone].appointmentsBooked++;
                    }
                }
            });

            const customersHtml = Object.values(customers).map(customer => `
                <div class="customer-card">
                    <div class="customer-header">
                        <div>
                            <div class="customer-name">${customer.name}</div>
                            <div class="customer-phone">${customer.phone}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.9rem; color: #666;">
                                ${customer.calls} call(s) | ${customer.appointmentsBooked} appointment(s)
                            </div>
                        </div>
                    </div>
                    
                    <div class="customer-details">
                        <div class="detail-item">
                            <div class="detail-label">Email</div>
                            <div class="detail-value">${customer.email || 'Not provided'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Vehicle</div>
                            <div class="detail-value">${customer.carYear || ''} ${customer.carMake || ''} ${customer.carModel || ''}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Triangle Member</div>
                            <div class="detail-value">${customer.triangleMember ? 'Yes' : 'No'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Location</div>
                            <div class="detail-value">${customer.location || 'Not specified'}</div>
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('customers-content').innerHTML = customersHtml;
        }

        // Display appointments - Calendar style
        function displayAppointments() {
            if (!currentData || currentData.length === 0) {
                document.getElementById('appointments-content').innerHTML = 
                    '<div class="no-data">No appointments found.</div>';
                return;
            }

            // Check for corrupted data
            const corruptedSessions = currentData.filter(session => {
                const customerInfo = session.customerInfo;
                return !customerInfo || Object.values(customerInfo).every(value => value === null || value === undefined);
            });

            if (corruptedSessions.length > 0) {
                document.getElementById('appointments-content').innerHTML = `
                    <div class="error-state">
                        <h3>‚ö†Ô∏è Data Corruption Detected</h3>
                        <p>Appointment data is corrupted due to a cleanup process issue.</p>
                    </div>
                `;
                return;
            }

            const appointments = currentData.filter(session => {
                const customerInfo = session.customerInfo;
                const hasEssentialInfo = customerInfo.name && customerInfo.phone && customerInfo.serviceType;
                const hasAppointment = session.appointmentBooked === true || 
                                     (customerInfo.preferredDate && customerInfo.preferredTime);
                return hasEssentialInfo && hasAppointment;
            });
            
            if (appointments.length === 0) {
                document.getElementById('appointments-content').innerHTML = `
                    <div class="error-state">
                        <h3>‚ö†Ô∏è No Valid Appointments</h3>
                        <p>All appointment data appears to be corrupted or incomplete.</p>
                    </div>
                `;
                return;
            }

            // Group appointments by date
            const appointmentsByDate = {};
            appointments.forEach(session => {
                let appointmentDate, appointmentTime;
                
                if (session.customerInfo.preferredDate && session.customerInfo.preferredTime) {
                    appointmentDate = session.customerInfo.preferredDate;
                    appointmentTime = session.customerInfo.preferredTime;
                } else if (session.appointmentDetails && session.appointmentDetails.date && session.appointmentDetails.time) {
                    appointmentDate = session.appointmentDetails.date;
                    appointmentTime = session.appointmentDetails.time;
                } else {
                    return;
                }
                
                let formattedDate, displayDate, calendarDate;
                try {
                    if (appointmentDate.includes(' ')) {
                        const parsed = parseNaturalDate(appointmentDate);
                        calendarDate = parsed;
                        displayDate = parsed.toLocaleDateString('en-US', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        });
                        formattedDate = parsed.toISOString().split('T')[0];
                    } else {
                        calendarDate = new Date(appointmentDate);
                        displayDate = calendarDate.toLocaleDateString('en-US', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        });
                        formattedDate = appointmentDate;
                    }
                } catch (e) {
                    console.warn('Could not parse date:', appointmentDate, e);
                    return;
                }
                
                if (!appointmentsByDate[formattedDate]) {
                    appointmentsByDate[formattedDate] = [];
                }
                
                appointmentsByDate[formattedDate].push({
                    ...session,
                    parsedDate: calendarDate,
                    formattedDate: formattedDate,
                    displayDate: displayDate,
                    appointmentTime: appointmentTime,
                    displayTime: formatTime(appointmentTime)
                });
            });
            
            const sortedDates = Object.keys(appointmentsByDate).sort();
            
            const appointmentsHtml = sortedDates.map(date => {
                const dayAppointments = appointmentsByDate[date].sort((a, b) => 
                    a.appointmentTime.localeCompare(b.appointmentTime)
                );
                
                const firstAppointment = dayAppointments[0];
                const dayOfWeek = firstAppointment.parsedDate.toLocaleDateString('en-US', { weekday: 'short' });
                const dayNumber = firstAppointment.parsedDate.getDate();
                const month = firstAppointment.parsedDate.toLocaleDateString('en-US', { month: 'short' });
                
                const dayAppointmentsHtml = dayAppointments.map(appointment => {
                    const cleanCallId = appointment.callId.replace(/retell-function-|retell-|function-/gi, 'Call-');
                    
                    return `
                        <div class="appointment-item">
                            <div class="appointment-time">
                                <div class="time-display">${appointment.displayTime}</div>
                                <div class="time-slot">1 hour slot</div>
                            </div>
                            
                            <div class="appointment-details">
                                <div class="customer-name">${appointment.customerInfo.name}</div>
                                <div class="service-type">${getServiceTypeName(appointment.customerInfo.serviceType)}</div>
                                <div class="vehicle-info">
                                    ${appointment.customerInfo.carYear || ''} ${appointment.customerInfo.carMake || ''} ${appointment.customerInfo.carModel || ''}
                                </div>
                                <div style="font-size: 0.85rem; color: #555;">
                                    üìç ${appointment.customerInfo.location || 'Location not specified'}
                                </div>
                                <div style="font-size: 0.8rem; color: #888;">
                                    ${appointment.customerInfo.triangleMember ? 'üî∫ Triangle Member' : 'üë§ Regular Customer'}
                                </div>
                            </div>
                            
                            <div class="appointment-meta">
                                <div class="call-id">Call: ${cleanCallId}</div>
                                <div style="font-style: italic;">
                                    Booked: ${new Date(appointment.lastActivity).toLocaleString()}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="calendar-day">
                        <div class="day-header">
                            <div class="day-date">
                                <div class="day-number">${dayNumber}</div>
                                <div class="day-info">
                                    <div class="day-name">${dayOfWeek}</div>
                                    <div class="month-name">${month}</div>
                                </div>
                            </div>
                            <div class="day-stats">
                                <div class="appointment-count">${dayAppointments.length} appointment${dayAppointments.length > 1 ? 's' : ''}</div>
                                <div class="day-utilization">${Math.round((dayAppointments.length / 9) * 100)}% booked</div>
                            </div>
                        </div>
                        
                        <div class="day-appointments">
                            ${dayAppointmentsHtml}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('appointments-content').innerHTML = appointmentsHtml;
        }

        // Display analytics
        function displayAnalytics() {
            if (!currentData || currentData.length === 0) {
                document.getElementById('analytics-content').innerHTML = 
                    '<div class="no-data">No data available for analytics.</div>';
                return;
            }

            // Check for corrupted data
            const corruptedSessions = currentData.filter(session => {
                const customerInfo = session.customerInfo;
                return !customerInfo || Object.values(customerInfo).every(value => value === null || value === undefined);
            });

            if (corruptedSessions.length > 0) {
                document.getElementById('analytics-content').innerHTML = `
                    <div class="error-state">
                        <h3>‚ö†Ô∏è Data Corruption Detected</h3>
                        <p>Analytics data is corrupted due to a cleanup process issue.</p>
                    </div>
                `;
                return;
            }

            const completeSessions = currentData.filter(session => {
                const customerInfo = session.customerInfo;
                return customerInfo.name && customerInfo.phone && customerInfo.serviceType;
            });

            if (completeSessions.length === 0) {
                document.getElementById('analytics-content').innerHTML = `
                    <div class="error-state">
                        <h3>‚ö†Ô∏è No Valid Analytics Data</h3>
                        <p>All analytics data appears to be corrupted or incomplete.</p>
                    </div>
                `;
                return;
            }

            const totalCalls = completeSessions.length;
            const activeCalls = completeSessions.filter(s => s.status === 'active').length;
            const appointmentsBooked = completeSessions.filter(s => s.appointmentBooked).length;
            const conversionRate = totalCalls > 0 ? Math.round((appointmentsBooked / totalCalls) * 100) : 0;
            
            // Service type distribution
            const serviceTypes = {};
            completeSessions.forEach(session => {
                const serviceType = session.customerInfo.serviceType;
                if (serviceType) {
                    serviceTypes[serviceType] = (serviceTypes[serviceType] || 0) + 1;
                }
            });

            // Location performance
            const locations = {};
            completeSessions.forEach(session => {
                const location = session.customerInfo.location;
                if (location) {
                    if (!locations[location]) {
                        locations[location] = { count: 0, appointments: 0 };
                    }
                    locations[location].count++;
                    if (session.appointmentBooked) {
                        locations[location].appointments++;
                    }
                }
            });

            const analyticsHtml = `
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <h3>üìä Performance Overview</h3>
                        <div class="metrics-grid">
                            <div class="metric-item">
                                <div class="metric-value">${totalCalls}</div>
                                <div class="metric-label">Total Calls</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value">${conversionRate}%</div>
                                <div class="metric-label">Conversion Rate</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value">${appointmentsBooked}</div>
                                <div class="metric-label">Appointments</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value">${activeCalls}</div>
                                <div class="metric-label">Active Calls</div>
                            </div>
                        </div>
                    </div>

                    <div class="analytics-card">
                        <h3>üîß Service Distribution</h3>
                        ${Object.keys(serviceTypes).length > 0 ? 
                            Object.entries(serviceTypes).map(([service, count]) => `
                                <div class="service-metric">
                                    <span class="service-name">${getServiceTypeName(service)}</span>
                                    <span class="service-count">${count}</span>
                                </div>
                            `).join('') : 
                            '<div class="no-data">No service types recorded</div>'
                        }
                    </div>

                    <div class="analytics-card">
                        <h3>üìç Location Performance</h3>
                        ${Object.keys(locations).length > 0 ? 
                            Object.entries(locations).map(([location, data]) => `
                                <div class="location-metric">
                                    <span class="location-name">${location}</span>
                                    <span class="location-count">${data.count} calls</span>
                                </div>
                            `).join('') : 
                            '<div class="no-data">No locations recorded</div>'
                        }
                    </div>
                </div>
            `;

            document.getElementById('analytics-content').innerHTML = analyticsHtml;
        }

        // Helper functions
        function showErrorState(message) {
            const errorHtml = `
                <div class="error-state">
                    <h3>‚ùå Error Loading Data</h3>
                    <p>${message}</p>
                    <p><strong>Please try refreshing the page or contact support.</strong></p>
                </div>
            `;
            
            document.getElementById('sessions-content').innerHTML = errorHtml;
            document.getElementById('customers-content').innerHTML = errorHtml;
            document.getElementById('appointments-content').innerHTML = errorHtml;
            document.getElementById('analytics-content').innerHTML = errorHtml;
        }

        function saveDataToStorage(data) {
            try {
                localStorage.setItem('ct_dashboard_data', JSON.stringify({
                    data: data,
                    timestamp: new Date().toISOString(),
                    version: '2.0'
                }));
            } catch (error) {
                console.error('Error saving data to localStorage:', error);
            }
        }

        function loadDataFromStorage() {
            try {
                const stored = localStorage.getItem('ct_dashboard_data');
                if (stored) {
                    const parsed = JSON.parse(stored);
                    const dataAge = new Date() - new Date(parsed.timestamp);
                    const maxAge = 24 * 60 * 60 * 1000; // 24 hours
                    
                    if (dataAge < maxAge) {
                        return parsed.data;
                    } else {
                        localStorage.removeItem('ct_dashboard_data');
                    }
                }
            } catch (error) {
                console.error('Error loading data from localStorage:', error);
                localStorage.removeItem('ct_dashboard_data');
            }
            return null;
        }

        function parseNaturalDate(dateString) {
            const lowerString = dateString.toLowerCase();
            
            if (lowerString.includes('today')) {
                return new Date();
            } else if (lowerString.includes('tomorrow')) {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                return tomorrow;
            }
            
            const daysOfWeek = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            for (let i = 0; i < daysOfWeek.length; i++) {
                if (lowerString.includes(daysOfWeek[i])) {
                    const targetDay = new Date();
                    const currentDay = targetDay.getDay();
                    const targetDayNum = i + 1;
                    const daysToAdd = (targetDayNum + 7 - currentDay) % 7;
                    if (daysToAdd === 0) daysToAdd = 7;
                    targetDay.setDate(targetDay.getDate() + daysToAdd);
                    return targetDay;
                }
            }
            
            return new Date();
        }

        function formatTime(timeString) {
            if (!timeString) return 'Time not specified';
            
            try {
                if (timeString.includes('am') || timeString.includes('pm')) {
                    return timeString.toUpperCase();
                } else if (timeString.includes(':')) {
                    const [hours, minutes] = timeString.split(':');
                    const hour = parseInt(hours);
                    const ampm = hour >= 12 ? 'PM' : 'AM';
                    const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
                    return `${displayHour}:${minutes} ${ampm}`;
                } else {
                    const hour = parseInt(timeString);
                    const ampm = hour >= 12 ? 'PM' : 'AM';
                    const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
                    return `${displayHour}:00 ${ampm}`;
                }
            } catch (e) {
                return timeString;
            }
        }

        function getServiceTypeName(serviceType) {
            const serviceNames = {
                'oil_change': 'Oil Change',
                'tire_rotation': 'Tire Rotation',
                'brake_service': 'Brake Service',
                'battery_service': 'Battery Service',
                'inspection': 'Vehicle Inspection',
                'general_service': 'General Service'
            };
            
            return serviceNames[serviceType] || serviceType || 'Service not specified';
        }

        // Initialize dashboard
        loadInitialData();
    </script>
</body>
</html>
