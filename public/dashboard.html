<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canadian Tire - Service Appointments</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            padding: 0;
        }

        /* --- Canadian Tire style header (non-intrusive to data flow) --- */
        .brand-bar {
            background: #1f1f1f;
            color: #ffffff;
            border-bottom: 3px solid #e31837;
        }
        .brand-wrap {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 18px;
            padding: 12px 20px;
        }
        .brand-logo {
            height: 26px;
            width: auto;
            display: block;
        }
        .brand-divider { height: 22px; width: 1px; background: #3a3a3a; }
        .brand-title {
            font-weight: 700;
            letter-spacing: 0.2px;
            font-size: 14px;
        }
        .brand-flex { display: flex; align-items: center; gap: 10px; }
        .brand-pill {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            padding: 6px 10px;
            border-radius: 16px;
            font-size: 12px;
            color: #dcdcdc;
        }
        .brand-actions { margin-left: auto; display: flex; align-items: center; gap: 10px; }
        .brand-btn {
            background: #e31837;
            color: #fff;
            border: none;
            padding: 8px 14px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
        }
        .brand-btn.alt {
            background: transparent;
            border: 1px solid #3a3a3a;
            color: #e6e6e6;
        }

        /* page container below the header */
        .page-wrap { max-width: 1200px; margin: 16px auto; padding: 0 20px 24px; }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #d32f2f;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #d32f2f;
            padding-bottom: 10px;
        }
        
        .appointment-item {
            background: #f9f9f9;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #d32f2f;
        }
        
        .appointment-item h3 {
            color: #d32f2f;
            margin-bottom: 10px;
        }
        
        .appointment-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 14px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
        }
        
        .detail-label {
            font-weight: bold;
            color: #666;
        }
        
        .detail-value {
            color: #333;
        }
        
        .calendar-view {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
        }
        
        .date-group {
            margin-bottom: 20px;
        }
        
        .date-header {
            background: #d32f2f;
            color: white;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .time-slot {
            background: white;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            border-left: 3px solid #4caf50;
        }
        
        /* Calendar day cards */
        .calendar-day { 
            background: #ffffff; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); 
            margin-bottom: 16px; 
            overflow: hidden; 
            border: 1px solid #eee;
        }
        .day-header { 
            background: #d32f2f; 
            color: #fff; 
            padding: 12px 14px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
        }
        .day-title { font-weight: 700; letter-spacing: 0.2px; }
        .day-count { 
            font-size: 12px; 
            background: rgba(255,255,255,0.18); 
            padding: 4px 10px; 
            border-radius: 12px; 
        }
        .day-appointments { padding: 12px; }
        .appt-item { 
            background: #fafafa; 
            border: 1px solid #eee; 
            border-radius: 6px; 
            padding: 10px 12px; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            margin-bottom: 8px; 
        }
        .appt-time { min-width: 84px; font-weight: 700; color: #2e7d32; }
        .appt-main { font-weight: 600; color: #333; }
        .appt-sub { font-size: 12px; color: #666; }

        /* Review-style cards (professional layout) */
        .review-card { background: #fff; border: 1px solid #e9e9e9; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 14px; }
        .review-header { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; font-weight: 700; color: #222; }
        .review-body { padding: 0 16px 16px; }
        .review-grid { display: grid; grid-template-columns: 200px 1fr; column-gap: 18px; row-gap: 10px; }
        .review-label { color: #6b7280; }
        .review-value { color: #111827; font-weight: 600; }

        /* Calendar tiles */
        .calendar-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 14px; }
        .calendar-tile { background: #fff; border: 1px solid #e9e9e9; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden; }
        .tile-header { background: #d32f2f; color: #fff; padding: 10px 12px; font-weight: 700; }
        .tile-body { padding: 12px; display: grid; row-gap: 6px; }
        .tile-line { font-size: 13px; color: #333; }
        .tile-strong { font-weight: 700; }
        
        .loading {
            text-align: center;
            color: #666;
            padding: 40px;
        }
        
        .no-data {
            text-align: center;
            color: #666;
            padding: 40px;
            font-style: italic;
        }
        
        .refresh-btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .refresh-btn:hover {
            background: #1976d2;
        }
    </style>
</head>
<body>
    <!-- Professional header (visual only) -->
    <div class="brand-bar">
        <div class="brand-wrap">
            <img src="/public/images/ctlogo.png" alt="Canadian Tire" class="brand-logo" onerror="this.src='/images/ctlogo.png'">
            <span class="brand-title">Canadian Tire • Service Department</span>
            <span class="brand-divider"></span>
            <div class="brand-flex">
                <span class="brand-pill">Waterloo, ON</span>
                <span class="brand-pill">Open • 8:00 AM – 5:00 PM</span>
            </div>
            <div class="brand-actions">
                <a class="brand-btn alt" href="https://www.canadiantire.ca/en/ship-to-home/book-appointment.html" target="_blank" rel="noopener">Book Auto Service</a>
                <button class="brand-btn" onclick="loadAppointments()">Refresh Data</button>
            </div>
        </div>
    </div>

    <div class="page-wrap">

    <!-- keep legacy refresh for users; header also has a refresh button -->
    <button class="refresh-btn" onclick="loadAppointments()">🔄 Refresh Data</button>

    <div class="stats">
        <div class="stat-card">
            <div class="stat-number" id="totalAppointments">-</div>
            <div class="stat-label">Total Appointments</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="todayAppointments">-</div>
            <div class="stat-label">Today's Appointments</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="confirmedAppointments">-</div>
            <div class="stat-label">Confirmed</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="pendingAppointments">-</div>
            <div class="stat-label">Pending</div>
        </div>
    </div>

    <div class="main-content">
        <div class="section">
            <h2>👥 Customer Information</h2>
            <div id="customerList">
                <div class="loading">Loading customer data...</div>
            </div>
        </div>

        <div class="section">
            <h2>📅 Appointment Calendar</h2>
            <div id="calendarView">
                <div class="loading">Loading calendar...</div>
            </div>
        </div>
    </div>

    <script>
        // Helper to display times as EST (presentation only)
        function toEST(dateStr, timeStr) {
            try {
                const str = [dateStr || '', timeStr || ''].filter(Boolean).join(' ');
                return str.replace(/GMT|UTC/gi, 'EST');
            } catch (_) {
                return [dateStr || '', timeStr || ''].filter(Boolean).join(' ');
            }
        }

        // Format time values (handles Google Sheets Date objects like 1899-12-30 10:00:00 ...)
        function formatTimeEST(value) {
            if (value === null || value === undefined) return '';
            // If already in AM/PM plain text, keep
            const s = String(value).trim();
            if (/am|pm/i.test(s) && !/GMT|UTC/i.test(s)) return s.toUpperCase().replace(/\s+EST.*/i,'');
            // Try to parse as Date
            const d = new Date(s);
            if (!isNaN(d.getTime())) {
                return d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true, timeZone: 'America/Toronto' });
            }
            // If looks like HH:MM (24h), convert
            const m = s.match(/^(\d{1,2}):(\d{2})/);
            if (m) {
                let h = parseInt(m[1], 10);
                const min = m[2];
                const ampm = h >= 12 ? 'PM' : 'AM';
                if (h === 0) h = 12; else if (h > 12) h -= 12;
                return `${h}:${min} ${ampm}`;
            }
            // Fallback: strip timezone noise
            return s.replace(/GMT.*$/i, '').replace(/UTC.*$/i,'').trim();
        }

        function formatDateEST(value) {
            if (value === null || value === undefined) return '';
            const s = String(value).trim();
            // Try to parse known date strings
            const d = new Date(s);
            if (!isNaN(d.getTime())) {
                return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric', timeZone: 'America/Toronto' });
            }
            // Remove timezone noise if any
            return s.replace(/\s+\d{2}:\d{2}:\d{2}.*$/,'');
        }
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Dashboard loaded');
            loadAppointments();
        });

        async function loadAppointments() {
            try {
                console.log('🔄 Loading appointments...');
                
                // Show loading state
                document.getElementById('customerList').innerHTML = '<div class="loading">Loading customer data...</div>';
                document.getElementById('calendarView').innerHTML = '<div class="loading">Loading calendar...</div>';
                
                // Prefer Google Sheet via backend proxy if configured
                const response = await fetch('/api/sheet/appointments');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    displayCustomerInfo(data.appointments);
                    displayCalendar(data.appointments);
                    updateStats(data.appointments);
                } else {
                    throw new Error(data.message || 'Failed to load appointments');
                }
                
            } catch (error) {
                console.error('❌ Error loading appointments:', error);
                
                // Show user-friendly error message
                if (error.message.includes('404') || error.message.includes('Failed to fetch')) {
                    document.getElementById('customerList').innerHTML = `
                        <div class="no-data">
                            <h3>🚧 System Starting Up</h3>
                            <p>The appointment system is currently being deployed.</p>
                            <p>Please wait a few minutes and try refreshing.</p>
                            <p><small>Error: ${error.message}</small></p>
                        </div>
                    `;
                    document.getElementById('calendarView').innerHTML = `
                        <div class="no-data">
                            <h3>🚧 System Starting Up</h3>
                            <p>The appointment system is currently being deployed.</p>
                            <p>Please wait a few minutes and try refreshing.</p>
                        </div>
                    `;
                } else {
                    document.getElementById('customerList').innerHTML = `
                        <div class="no-data">
                            <h3>❌ Error Loading Data</h3>
                            <p>Failed to load appointments: ${error.message}</p>
                            <p>Please try refreshing the page.</p>
                        </div>
                    `;
                    document.getElementById('calendarView').innerHTML = `
                        <div class="no-data">
                            <h3>❌ Error Loading Data</h3>
                            <p>Failed to load appointments: ${error.message}</p>
                            <p>Please try refreshing the page.</p>
                        </div>
                    `;
                }
                
                // Reset stats to show error state
                document.getElementById('totalAppointments').textContent = '?';
                document.getElementById('todayAppointments').textContent = '?';
                document.getElementById('confirmedAppointments').textContent = '?';
                document.getElementById('pendingAppointments').textContent = '?';
            }
        }

        function displayCustomerInfo(appointments) {
            const container = document.getElementById('customerList');
            
            if (!appointments || appointments.length === 0) {
                container.innerHTML = '<div class="no-data">No appointments found</div>';
                return;
            }

            const toEST = (d, t) => {
                if (!d && !t) return '';
                const str = [d || '', t || ''].filter(Boolean).join(' ');
                return str.replace(/GMT|UTC/gi, 'EST');
            };

            const cards = appointments.map(a => `
                <div class="review-card">
                    <div class="review-header">Contact Information</div>
                    <div class="review-body">
                        <div class="review-grid">
                            <div class="review-label">Name</div><div class="review-value">${a.customerName || ''}</div>
                            <div class="review-label">Email</div><div class="review-value">${a.email || 'N/A'}</div>
                            <div class="review-label">Mobile Phone</div><div class="review-value">${a.phone || ''}</div>
                            <div class="review-label">Vehicle</div><div class="review-value">${[a.carYear,a.carMake,a.carModel].filter(Boolean).join(' ')}</div>
                            <div class="review-label">Location</div><div class="review-value">${a.location || ''}</div>
                            <div class="review-label">Triangle Member</div><div class="review-value">${a.triangleMember ? 'Yes' : 'No'}</div>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = cards;
        }

        function displayCalendar(appointments) {
            const container = document.getElementById('calendarView');
            
            if (!appointments || appointments.length === 0) {
                container.innerHTML = '<div class="no-data">No appointments found</div>';
                return;
            }

            // Group appointments by date
            const appointmentsByDate = {};
            appointments.forEach(appointment => {
                const date = appointment.appointmentDate;
                if (!appointmentsByDate[date]) {
                    appointmentsByDate[date] = [];
                }
                appointmentsByDate[date].push(appointment);
            });

            // Sort dates
            const sortedDates = Object.keys(appointmentsByDate).sort();

            const calendarHtml = (() => {
                // grid of tiles, each appointment is a tile styled like a calendar day
                const tiles = appointments
                  .sort((a,b) => ((a.appointmentDate||'') + ' ' + (a.appointmentTime||'')).localeCompare((b.appointmentDate||'') + ' ' + (b.appointmentTime||'')))
                  .map(a => `
                    <div class="calendar-tile">
                        <div class="tile-header">${formatDateEST(a.appointmentDate || '')}${a.appointmentTime ? ' • ' + formatTimeEST(a.appointmentTime) : ''}</div>
                        <div class="tile-body">
                            <div class="tile-line tile-strong">${a.customerName || 'Customer'}</div>
                            <div class="tile-line">${a.serviceType || 'Service'}</div>
                            <div class="tile-line">${[a.carYear,a.carMake,a.carModel].filter(Boolean).join(' ')}</div>
                            <div class="tile-line">${formatTimeEST(a.appointmentTime || '')}</div>
                        </div>
                    </div>
                  `).join('');
                return `<div class="calendar-grid">${tiles}</div>`;
            })();

            container.innerHTML = calendarHtml;
        }

        function updateStats(appointments) {
            const total = appointments.length;
            const today = new Date().toDateString();
            const todayCount = appointments.filter(a => new Date(a.appointmentDate).toDateString() === today).length;
            const confirmed = appointments.filter(a => a.status === 'confirmed').length;
            const pending = appointments.filter(a => a.status === 'pending').length;

            document.getElementById('totalAppointments').textContent = total;
            document.getElementById('todayAppointments').textContent = todayCount;
            document.getElementById('confirmedAppointments').textContent = confirmed;
            document.getElementById('pendingAppointments').textContent = pending;
        }

        function showError(message) {
            console.error('❌ Error:', message);
            // You can add a visual error display here if needed
        }

        // Auto-refresh every 60 seconds
        setInterval(loadAppointments, 60000);
    </script>
</body>
</html>